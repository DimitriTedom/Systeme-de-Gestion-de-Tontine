================================================================================
                    GUIDE DE MIGRATION - CR√âDIT REMBOURSEMENT
================================================================================

Date: 22 janvier 2026
Migration: 002_fix_credit_repayment_status.sql

PROBL√àMES CORRIG√âS :
--------------------
1. ‚úÖ Les cr√©dits ne passaient jamais √† l'√©tat "Rembours√©"
2. ‚úÖ Le bouton "Rembourser" n'apparaissait pas pour les cr√©dits d√©caiss√©s
3. ‚úÖ La fonction RPC ne g√©rait pas correctement la transition decaisse ‚Üí en_cours

CHANGEMENTS EFFECTU√âS :
-----------------------
1. Interface utilisateur (Credits.tsx) :
   - Bouton "Rembourser" maintenant visible pour : decaisse, en_cours, en_retard, defaut
   - Avant : uniquement en_cours et en_retard

2. Migration base de donn√©es (002_fix_credit_repayment_status.sql) :
   - Fonction rembourser_credit am√©lior√©e
   - G√®re correctement : decaisse ‚Üí en_cours ‚Üí rembourse
   - Pr√©serve en_retard et defaut jusqu'au remboursement complet
   - Validation du montant (ne peut pas d√©passer le solde)
   - Validation que le montant est > 0

POUR APPLIQUER LA MIGRATION SUR SUPABASE :
-------------------------------------------

M√âTHODE 1 : Via Supabase Dashboard (Recommand√©)
------------------------------------------------
1. Allez sur https://supabase.com
2. Connectez-vous √† votre projet
3. Allez dans "SQL Editor"
4. Cliquez sur "+ New query"
5. Copiez-collez le contenu du fichier :
   supabase/migrations/002_fix_credit_repayment_status.sql
6. Cliquez sur "Run" (ou Ctrl+Enter)
7. V√©rifiez qu'il n'y a pas d'erreurs

M√âTHODE 2 : Via Supabase CLI (Si install√© localement)
------------------------------------------------------
cd /home/snowdev/Documents/UY1/222/TP\ S1/Systeme-de-Gestion-de-Tontine
supabase db push

V√âRIFICATION QUE LA MIGRATION A R√âUSSI :
-----------------------------------------
1. Dans Supabase SQL Editor, ex√©cutez :
   
   SELECT routine_name, routine_type 
   FROM information_schema.routines 
   WHERE routine_name = 'rembourser_credit';
   
   R√©sultat attendu : 1 ligne avec routine_type = 'FUNCTION'

2. Testez la fonction avec un cr√©dit de test :
   
   -- Cr√©ez un cr√©dit de test (ajustez les IDs)
   INSERT INTO credit (id_membre, montant, solde, taux_interet, 
                       date_remboursement_prevue, statut)
   VALUES ('votre-id-membre', 10000, 10000, 5, 
           CURRENT_DATE + INTERVAL '30 days', 'decaisse');
   
   -- Testez le remboursement partiel
   SELECT * FROM rembourser_credit(
       'id-du-credit-cr√©√©'::uuid, 
       5000
   );
   
   -- V√©rifiez que le statut est pass√© √† 'en_cours'
   
   -- Testez le remboursement complet
   SELECT * FROM rembourser_credit(
       'id-du-credit-cr√©√©'::uuid, 
       5000
   );
   
   -- V√©rifiez que le statut est pass√© √† 'rembourse'

R√àGLE IMPORTANTE : UN SEUL CR√âDIT ACTIF PAR MEMBRE
---------------------------------------------------
Cette r√®gle √©tait D√âJ√Ä impl√©ment√©e ! La fonction verifier_credit_actif
existe et est appel√©e dans addCredit (creditStore.ts ligne 91).

Si vous voyez l'erreur :
"Ce membre a d√©j√† un cr√©dit actif. Il doit d'abord rembourser son cr√©dit en cours."

C'est NORMAL ! Le syst√®me fonctionne correctement.

Les cr√©dits actifs sont : en_attente, approuve, decaisse, en_cours, en_retard
Un membre doit rembourser compl√®tement son cr√©dit (statut = rembourse) 
avant de pouvoir en demander un nouveau.

APR√àS LA MIGRATION :
--------------------
1. Rechargez l'application web
2. Allez dans "Cr√©dits"
3. D√©caissez un cr√©dit (le bouton üì§ "D√©caisser")
4. Le bouton üíµ "Rembourser" devrait appara√Ætre imm√©diatement
5. Testez un remboursement partiel
6. V√©rifiez que le statut passe √† "En cours"
7. Testez un remboursement complet
8. V√©rifiez que le statut passe √† "Rembours√©"

ROLLBACK (En cas de probl√®me) :
--------------------------------
Si la migration cause des probl√®mes, vous pouvez revenir √† l'ancienne version :

-- Dans Supabase SQL Editor :
DROP FUNCTION IF EXISTS rembourser_credit(UUID, NUMERIC);

-- Puis copiez-collez l'ancienne fonction depuis :
-- supabase/migrations/001_init_schema.sql lignes 872-930

SUPPORT :
---------
Si vous rencontrez des probl√®mes, v√©rifiez :
1. Les logs Supabase (onglet "Logs" dans le dashboard)
2. La console du navigateur (F12) pour les erreurs JavaScript
3. GitHub Issues : https://github.com/DimitriTedom/Systeme-de-Gestion-de-Tontine/issues

================================================================================
                              FIN DU GUIDE
================================================================================
